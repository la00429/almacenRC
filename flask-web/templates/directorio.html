{% extends "base.html" %}

{% block title %}Directorio - Almac√©nRC{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-link"></i> Directorio Producto-Proveedor</h1>
    <div class="btn-group">
        <button class="btn btn-success" onclick="nuevaRelacion()">
            <i class="fas fa-plus"></i> Nueva Relaci√≥n
        </button>
        <button class="btn btn-outline-secondary" onclick="verRelacionesInactivas()">
            <i class="fas fa-eye-slash"></i> Ver Inactivas
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Relaciones Producto-Proveedor ({{ directorio|length }} registros)</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID Producto</th>
                        <th>Producto</th>
                        <th>Proveedor</th>
                        <th>Stock Actual</th>
                        <th>Precio</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in directorio %}
                    <tr>
                        <td>{{ item.id_producto }}</td>
                        <td>{{ item.producto }}</td>
                        <td>
                            <span class="badge bg-info">{{ item.proveedor }}</span>
                        </td>
                        <td>
                            <span class="badge {% if item.stock < 10 %}bg-danger{% elif item.stock < 50 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                {{ item.stock }} unidades
                            </span>
                        </td>
                        <td>${{ "{:,.0f}".format(item.precio) }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editarRelacion({{ item.id_producto }}, '{{ item.codigo_proveedor }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="verDetallesRelacion({{ item.id_producto }}, '{{ item.proveedor }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="eliminarRelacion({{ item.id_producto }}, '{{ item.codigo_proveedor }}')">
                                    <i class="fas fa-unlink"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editarRelacion(idProducto, codigoProveedor) {
    // Obtener lista de proveedores para mostrar opciones
    fetch('/api/proveedores')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let proveedoresList = '\nüîß CAMBIAR PROVEEDOR\n\nProveedores disponibles:\n';
                data.data.forEach(p => {
                    proveedoresList += `${p.codigo} - ${p.nombre}\n`;
                });
                
                const nuevoProveedor = prompt(`${proveedoresList}\nProducto ID: ${idProducto} (NO SE PUEDE CAMBIAR)\nProveedor actual: ${codigoProveedor}\n\nIngrese el nuevo c√≥digo de proveedor:`);
                
                if (nuevoProveedor && nuevoProveedor !== codigoProveedor && !isNaN(nuevoProveedor)) {
                    // Verificar que el proveedor existe
                    const proveedorExiste = data.data.find(p => p.codigo == nuevoProveedor);
                    if (!proveedorExiste) {
                        alert('‚ùå El c√≥digo de proveedor no existe');
                        return;
                    }
                    
                    // Primero eliminar la relaci√≥n actual
                    fetch(`/api/directorio/${idProducto}/${codigoProveedor}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(deleteData => {
                        if (deleteData.success) {
                            // Crear la nueva relaci√≥n
                            return fetch('/api/directorio', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    id_producto: parseInt(idProducto),
                                    codigo_proveedor: parseInt(nuevoProveedor)
                                })
                            });
                        } else {
                            throw new Error(deleteData.error);
                        }
                    })
                    .then(response => response.json())
                    .then(createData => {
                        if (createData.success) {
                            alert(`‚úÖ Proveedor cambiado exitosamente!\n\nProducto ID: ${idProducto}\nNuevo proveedor: ${proveedorExiste.nombre} (${nuevoProveedor})`);
                            location.reload();
                        } else {
                            alert('‚ùå Error al crear nueva relaci√≥n: ' + createData.error);
                        }
                    })
                    .catch(error => {
                        alert('‚ùå Error: ' + error.message);
                    });
                }
            }
        })
        .catch(() => alert('‚ùå Error al obtener proveedores'));
}

function verDetallesRelacion(idProducto, nombreProveedor) {
    fetch(`/api/productos/${idProducto}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                const p = data.data;
                const detalles = `
üîó DETALLES DE LA RELACI√ìN

üì¶ Producto: ${p.nombre} (ID: ${p.id_producto})
üè¢ Proveedor: ${nombreProveedor}
üìä Stock Actual: ${p.stock} unidades
üí∞ Precio: $${p.valor_unitario.toLocaleString()}
üìÖ Vencimiento: ${p.fecha_venc || 'No especificado'}
üßæ IVA: ${p.iva}%

${p.stock < 10 ? 'üö® ¬°STOCK CR√çTICO! Contactar proveedor urgente' : 
  p.stock < 30 ? '‚ö†Ô∏è Stock bajo, considerar pedido' : '‚úÖ Stock normal'}
                `;
                alert(detalles);
            }
        })
        .catch(() => alert('‚ùå Error al obtener detalles del producto'));
}

function eliminarRelacion(idProducto, codigoProveedor) {
    if (confirm(`‚ö†Ô∏è ¬øEst√° seguro de eliminar la relaci√≥n?\n\nProducto ID: ${idProducto}\nProveedor: ${codigoProveedor}\n\nEsta acci√≥n no se puede deshacer.`)) {
        fetch(`/api/directorio/${idProducto}/${codigoProveedor}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úÖ Relaci√≥n eliminada exitosamente!\n\nProducto ID: ${idProducto}\nProveedor: ${codigoProveedor}`);
                location.reload();
            } else {
                alert('‚ùå Error al eliminar: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    }
}

function nuevaRelacion() {
    // Obtener productos y proveedores disponibles
    Promise.all([
        fetch('/api/productos').then(r => r.json()),
        fetch('/api/proveedores').then(r => r.json())
    ])
    .then(([productosResp, proveedoresResp]) => {
        if (productosResp.success && proveedoresResp.success) {
            // Mostrar productos disponibles
            let productosList = '\nüì¶ NUEVA RELACI√ìN - SELECCIONAR PRODUCTO\n\nProductos disponibles:\n';
            productosResp.data.forEach(p => {
                productosList += `${p.id_producto} - ${p.nombre} (Stock: ${p.stock})\n`;
            });
            
            const idProducto = prompt(`${productosList}\nIngrese el ID del producto:`);
            
            if (idProducto && !isNaN(idProducto)) {
                const productoExiste = productosResp.data.find(p => p.id_producto == idProducto);
                if (!productoExiste) {
                    alert('‚ùå El ID del producto no existe');
                    return;
                }
                
                // Mostrar proveedores disponibles
                let proveedoresList = '\nüè¢ SELECCIONAR PROVEEDOR\n\nProveedores disponibles:\n';
                proveedoresResp.data.forEach(p => {
                    proveedoresList += `${p.codigo} - ${p.nombre} (Tel: ${p.telefono})\n`;
                });
                
                const codigoProveedor = prompt(`${proveedoresList}\nProducto seleccionado: ${productoExiste.nombre}\n\nIngrese el c√≥digo del proveedor:`);
                
                if (codigoProveedor && !isNaN(codigoProveedor)) {
                    const proveedorExiste = proveedoresResp.data.find(p => p.codigo == codigoProveedor);
                    if (!proveedorExiste) {
                        alert('‚ùå El c√≥digo de proveedor no existe');
                        return;
                    }
                    
                    // Crear la relaci√≥n
                    fetch('/api/directorio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id_producto: parseInt(idProducto),
                            codigo_proveedor: parseInt(codigoProveedor)
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`‚úÖ Nueva relaci√≥n creada exitosamente!\n\nüì¶ Producto: ${productoExiste.nombre} (${idProducto})\nüè¢ Proveedor: ${proveedorExiste.nombre} (${codigoProveedor})`);
                            location.reload();
                        } else {
                            alert('‚ùå Error al crear relaci√≥n: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('‚ùå Error de conexi√≥n: ' + error.message);
                    });
                }
            }
        }
         })
     .catch(() => alert('‚ùå Error al obtener datos'));
}

function verRelacionesInactivas() {
    // Obtener productos que NO tienen proveedor asignado
    fetch('/api/productos')
        .then(response => response.json())
        .then(productosResp => {
            if (productosResp.success) {
                fetch('/api/directorio')
                    .then(response => response.json())
                    .then(directorioResp => {
                        if (directorioResp.success) {
                            // Encontrar productos sin proveedor
                            const productosConProveedor = directorioResp.data.map(d => d.id_producto);
                            const productosSinProveedor = productosResp.data.filter(p => 
                                !productosConProveedor.includes(p.id_producto)
                            );
                            
                            if (productosSinProveedor.length === 0) {
                                alert('‚úÖ PRODUCTOS SIN PROVEEDOR\n\nTodos los productos tienen proveedor asignado');
                            } else {
                                let mensaje = `‚ö†Ô∏è PRODUCTOS SIN PROVEEDOR\n\nTotal: ${productosSinProveedor.length} productos\n\n`;
                                productosSinProveedor.forEach(p => {
                                    const estado = p.stock < 10 ? 'üö®' : p.stock < 30 ? '‚ö†Ô∏è' : '‚úÖ';
                                    mensaje += `${estado} ${p.nombre} (ID: ${p.id_producto})\n   üìä Stock: ${p.stock} | üí∞ $${p.valor_unitario.toLocaleString()}\n\n`;
                                });
                                mensaje += '\n¬øDesea asignar proveedores a estos productos?';
                                
                                if (confirm(mensaje)) {
                                    nuevaRelacion();
                                }
                            }
                        }
                    });
            }
        })
        .catch(() => alert('‚ùå Error al obtener datos'));
}
</script>
{% endblock %} 