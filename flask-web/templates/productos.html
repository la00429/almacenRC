{% extends "base.html" %}

{% block title %}Productos - Almac√©nRC{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-boxes"></i> Gesti√≥n de Productos</h1>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="fas fa-plus"></i> Nuevo Producto
    </button>
</div>

<!-- Alert de restricciones -->
<div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="fas fa-info-circle"></i>
    <strong>Restricciones del sistema:</strong> 
    Nombre m√°ximo 30 caracteres | Stock m√°ximo 999 unidades | Precio m√°ximo $999,999 | ID se genera autom√°ticamente
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- Filtros y b√∫squeda -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar producto...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="stockFilter">
                    <option value="">üîç Filtrar por Stock</option>
                    <option value="critico">üö® Cr√≠tico (&lt; 10)</option>
                    <option value="bajo">‚ö†Ô∏è Bajo (10-29)</option>
                    <option value="normal">‚úÖ Normal (‚â• 30)</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="estadoFilter">
                    <option value="">üìä Filtrar por Estado</option>
                    <option value="CRITICO">üö® Cr√≠tico</option>
                    <option value="BAJO">‚ö†Ô∏è Bajo</option>
                    <option value="NORMAL">‚úÖ Normal</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltrosProductos()">
                    <i class="fas fa-times"></i> Limpiar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Grid de productos -->
<div class="row" id="productosGrid">
                    {% for producto in productos %}
    <div class="col-md-6 col-lg-4 mb-4 producto-card" data-nombre="{{ producto.nombre|lower }}" data-stock="{{ producto.stock }}" data-estado="{{ producto.estado }}" data-activo="{{ producto.activo }}">
        <div class="card h-100 {% if producto.activo == 'N' %}border-secondary bg-light{% elif producto.estado == 'CRITICO' %}border-danger{% elif producto.estado == 'BAJO' %}border-warning{% else %}border-success{% endif %}">
            <div class="card-header {% if producto.activo == 'N' %}bg-secondary text-white{% elif producto.estado == 'CRITICO' %}bg-danger text-white{% elif producto.estado == 'BAJO' %}bg-warning{% else %}bg-success text-white{% endif %}">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">üì¶ ID: {{ producto.id }}</h6>
                    <div>
                        {% if producto.activo == 'N' %}
                            <span class="badge bg-dark">üö´ INACTIVO</span>
                        {% else %}
                            <span class="badge {% if producto.estado == 'CRITICO' %}bg-light text-danger{% elif producto.estado == 'BAJO' %}bg-dark{% else %}bg-light text-success{% endif %}">
                                {% if producto.estado == 'CRITICO' %}üö® CR√çTICO{% elif producto.estado == 'BAJO' %}‚ö†Ô∏è BAJO{% else %}‚úÖ NORMAL{% endif %}
                            </span>
                            {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <h5 class="card-title text-truncate" title="{{ producto.nombre }}">
                    üìù {{ producto.nombre }}
                </h5>
                <div class="mb-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <i class="fas fa-boxes text-primary"></i>
                                <br><strong>{{ producto.stock }}</strong>
                                <br><small class="text-muted">Stock</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <i class="fas fa-dollar-sign text-success"></i>
                                <br><strong>${{ "{:,.0f}".format(producto.precio) }}</strong>
                                <br><small class="text-muted">Precio</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            üìÖ Venc: {{ producto.vencimiento or 'N/A' }} | 
                            üßæ IVA: {{ producto.iva }}%
                        </small>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                {% if producto.activo == 'N' %}
                    <!-- Producto INACTIVO - Solo habilitar y ver detalles -->
                    <div class="btn-group w-100 mb-2">
                        <button class="btn btn-outline-info btn-sm" onclick="verDetalles('{{ producto.id }}')">
                            <i class="fas fa-eye"></i> Ver Detalles
                        </button>
                    </div>
                    <button class="btn btn-success btn-sm w-100" onclick="habilitarProducto('{{ producto.id }}', '{{ producto.nombre }}')">
                        <i class="fas fa-check-circle"></i> Habilitar Producto
                                </button>
                {% else %}
                    <!-- Producto ACTIVO - Funciones normales -->
                    <div class="btn-group w-100 mb-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="editarProducto('{{ producto.id }}', '{{ producto.nombre }}')">
                            <i class="fas fa-edit"></i> Editar
                                </button>
                        <button class="btn btn-outline-info btn-sm" onclick="verDetalles('{{ producto.id }}')">
                            <i class="fas fa-eye"></i> Detalles
                                </button>
                            </div>
                    <button class="btn btn-outline-danger btn-sm w-100" onclick="inhabilitarProducto('{{ producto.id }}', '{{ producto.nombre }}')">
                        <i class="fas fa-ban"></i> Inhabilitar Producto
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Mensaje cuando no hay resultados -->
<div id="noResultsProductos" class="text-center py-5" style="display: none;">
    <i class="fas fa-search fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">No se encontraron productos</h4>
    <p class="text-muted">Prueba ajustando los filtros de b√∫squeda</p>
</div>

<!-- Modal para nuevo producto -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üÜï Nuevo Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="row">
                        <div class="col-md-6">
                    <div class="mb-3">
                                <label class="form-label">üìù Nombre</label>
                                <input type="text" class="form-control" name="nombre" required maxlength="30" 
                                       placeholder="Ej: Aceite de Motor 5W30" oninput="validarNombreProducto(this); validarFormularioProducto();">
                                <div class="form-text">
                                    <span id="contador_nombre_producto">0/30</span> caracteres
                                    <i class="fas fa-exclamation-triangle text-warning ms-2"></i>
                                    <small>M√°ximo 30 caracteres</small>
                                </div>
                                <div class="invalid-feedback" id="error_nombre_producto"></div>
                    </div>
                    <div class="mb-3">
                                <label class="form-label">üì¶ Stock Inicial</label>
                                <input type="number" class="form-control" name="stock" required min="0" max="999" 
                                       placeholder="0" oninput="validarStockProducto(this); validarFormularioProducto();">
                                <div class="form-text">
                                    <i class="fas fa-exclamation-triangle text-warning ms-2"></i>
                                    <small>M√°ximo 999 unidades (3 d√≠gitos)</small>
                                </div>
                                <div class="invalid-feedback" id="error_stock_producto"></div>
                    </div>
                    <div class="mb-3">
                                <label class="form-label">üí∞ Precio Unitario</label>
                                <input type="number" class="form-control" name="valor_unitario" step="0.01" required min="0" max="999999" 
                                       placeholder="0.00" oninput="validarPrecioProducto(this); validarFormularioProducto();">
                                <div class="form-text">
                                    <i class="fas fa-exclamation-triangle text-warning ms-2"></i>
                                    <small>M√°ximo $999,999 (6 d√≠gitos)</small>
                                </div>
                                <div class="invalid-feedback" id="error_precio_producto"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üìÖ Fecha Vencimiento</label>
                                <input type="date" class="form-control" name="fecha_venc">
                                <div class="form-text">Opcional - solo para productos perecederos</div>
                    </div>
                    <div class="mb-3">
                                <label class="form-label">üßæ IVA (%)</label>
                                <select class="form-select" name="iva" required>
                                    <option value="0">0% - Exento</option>
                                    <option value="19" selected>19% - Gravado</option>
                                </select>
                    </div>
                    <div class="mb-3">
                                <label class="form-label">üöö Proveedor Principal</label>
                                <select class="form-select" name="codigo_proveedor" id="proveedorSelect">
                                    <option value="">‚è≥ Cargando proveedores...</option>
                                </select>
                                <div class="form-text">Opcional - se puede asignar despu√©s</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="guardarProducto()">
                    <i class="fas fa-save"></i> Guardar Producto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar producto -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" name="id_producto" id="edit_id_producto">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üìù Nombre</label>
                                <input type="text" class="form-control" name="nombre" id="edit_nombre" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">üì¶ Stock</label>
                                <input type="number" class="form-control" name="stock" id="edit_stock" required min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">üí∞ Precio Unitario</label>
                                <input type="number" class="form-control" name="valor_unitario" id="edit_valor_unitario" step="0.01" required min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üìÖ Fecha Vencimiento</label>
                                <input type="date" class="form-control" name="fecha_venc" id="edit_fecha_venc">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">üßæ IVA (%)</label>
                                <select class="form-select" name="iva" id="edit_iva" required>
                                    <option value="0">0% - Exento</option>
                                    <option value="19">19% - Gravado</option>
                                </select>
                    </div>
                    <div class="mb-3">
                                <label class="form-label">üöö Proveedor Principal</label>
                                <select class="form-select" name="codigo_proveedor" id="edit_proveedorSelect">
                                    <option value="">Sin proveedor asignado</option>
                        </select>
                                <div class="form-text">Cambiar proveedor actual</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="actualizarProducto()">
                    <i class="fas fa-save"></i> Actualizar Producto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Resumen por estado -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <h5>Stock Cr√≠tico</h5>
                <h3>{{ productos | selectattr('estado', 'equalto', 'CRITICO') | list | length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-dark bg-warning">
            <div class="card-body">
                <h5>Stock Bajo</h5>
                <h3>{{ productos | selectattr('estado', 'equalto', 'BAJO') | list | length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5>Stock Normal</h5>
                <h3>{{ productos | selectattr('estado', 'equalto', 'NORMAL') | list | length }}</h3>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ========================================
// VALIDACIONES DE PRODUCTOS
// ========================================

function validarNombreProducto(input) {
    const valor = input.value;
    const contador = document.getElementById('contador_nombre_producto');
    const error = document.getElementById('error_nombre_producto');
    
    if (contador) contador.textContent = `${valor.length}/30`;
    
    if (valor.length === 0) {
        input.classList.remove('is-valid', 'is-invalid');
        if (error) error.textContent = '';
    } else if (valor.length > 30) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        if (error) error.textContent = '‚ùå El nombre no puede exceder 30 caracteres';
    } else if (valor.length < 3) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        if (error) error.textContent = '‚ö†Ô∏è El nombre debe tener al menos 3 caracteres';
    } else {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
        if (error) error.textContent = '';
    }
}

function validarStockProducto(input) {
    const valor = parseInt(input.value) || 0;
    const error = document.getElementById('error_stock_producto');
    
    if (input.value === '') {
        input.classList.remove('is-valid', 'is-invalid');
        if (error) error.textContent = '';
    } else if (valor < 0) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        if (error) error.textContent = '‚ùå El stock no puede ser negativo';
    } else if (valor > 999) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        if (error) error.textContent = '‚ùå El stock no puede exceder 999 unidades';
    } else {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
        if (error) error.textContent = '';
    }
}

function validarPrecioProducto(input) {
    const valor = parseFloat(input.value) || 0;
    const error = document.getElementById('error_precio_producto');
    
    if (input.value === '') {
        input.classList.remove('is-valid', 'is-invalid');
        if (error) error.textContent = '';
    } else if (valor <= 0) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        if (error) error.textContent = '‚ùå El precio debe ser mayor a 0';
    } else if (valor > 999999) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        if (error) error.textContent = '‚ùå El precio no puede exceder $999,999';
    } else {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
        if (error) error.textContent = '';
    }
}
function aplicarFiltros() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const stockFilter = document.getElementById('stockFilter').value;
    const estadoFilter = document.getElementById('estadoFilter').value;
    const productosGrid = document.getElementById('productosGrid');
    const rows = productosGrid.getElementsByClassName('producto-card');
    
    for (let row of rows) {
        const nombre = row.getAttribute('data-nombre');
        const stock = row.getAttribute('data-stock');
        const estado = row.getAttribute('data-estado');
        
        const matchSearch = nombre.includes(searchText);
        const matchFilter = !stockFilter || stockFilter === 'critico' && parseInt(stock) < 10 ||
                          stockFilter === 'bajo' && parseInt(stock) >= 10 && parseInt(stock) <= 29 ||
                          stockFilter === 'normal' && parseInt(stock) >= 30;
        
        const matchEstado = !estadoFilter || estado === estadoFilter;
        
        row.style.display = (matchSearch && matchFilter && matchEstado) ? '' : 'none';
    }
}

function editarProducto(id, nombre) {
    // Cargar datos del producto y abrir modal de edici√≥n
    fetch(`/api/productos/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                const producto = data.data;
                
                // Llenar el formulario de edici√≥n
                document.getElementById('edit_id_producto').value = producto.id_producto;
                document.getElementById('edit_nombre').value = producto.nombre;
                document.getElementById('edit_stock').value = producto.stock;
                document.getElementById('edit_valor_unitario').value = producto.valor_unitario;
                document.getElementById('edit_fecha_venc').value = producto.fecha_venc || '';
                document.getElementById('edit_iva').value = producto.iva;
                
                // Cargar proveedores y seleccionar el actual
                cargarProveedoresParaEdicion(producto.id_producto);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                modal.show();
            }
        })
        .catch(() => alert('‚ùå Error al obtener datos del producto'));
}

function verDetalles(id) {
    fetch(`/api/productos/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                const p = data.data;
                const detalles = `
üì¶ DETALLES DEL PRODUCTO

üÜî ID: ${p.id_producto}
üìù Nombre: ${p.nombre}
üìä Stock: ${p.stock} unidades
üí∞ Precio: $${p.valor_unitario.toLocaleString()}
üìÖ Vencimiento: ${p.fecha_venc || 'No especificado'}
üßæ IVA: ${p.iva}%
‚ö†Ô∏è Estado: ${p.estado_stock}

${p.estado_stock === 'CRITICO' ? 'üö® ¬°ATENCI√ìN! Stock cr√≠tico' : ''}
                `;
                alert(detalles);
            }
        })
        .catch(() => alert('‚ùå Error al obtener detalles'));
}

function ajustarStock(id, nombre, stockActual) {
    const nuevoStock = prompt('üì¶ Ingrese el nuevo stock para el producto ID ' + id + ':');
    if (nuevoStock !== null && !isNaN(nuevoStock) && nuevoStock >= 0) {
        // FUNCIONALIDAD REAL - actualizar via API
        fetch(`/api/productos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock: parseInt(nuevoStock) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úÖ Stock actualizado exitosamente!\n\nProducto ID: ${id}\nNuevo stock: ${nuevoStock} unidades`);
                location.reload(); // Recargar para mostrar cambios
            } else {
                alert('‚ùå Error al actualizar: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    } else if (nuevoStock !== null) {
        alert('‚ùå Por favor ingrese un n√∫mero v√°lido mayor o igual a 0');
    }
}

function guardarProducto() {
    const form = document.getElementById('addProductForm');
    const formData = new FormData(form);
    
    const producto = {
        id_marca: 1, // Marca por defecto
        nombre: formData.get('nombre'),
        stock: parseInt(formData.get('stock')),
        valor_unitario: parseFloat(formData.get('valor_unitario')),
        fecha_venc: formData.get('fecha_venc') || null,
        iva: parseInt(formData.get('iva'))
    };
    
    const proveedorSeleccionado = formData.get('codigo_proveedor');
    
    // Validaci√≥n b√°sica
    if (!producto.nombre || producto.stock === null || !producto.valor_unitario) {
        alert('‚ùå Por favor complete todos los campos obligatorios');
        return;
    }
    
    // FUNCIONALIDAD REAL - crear via API
    // Agregar proveedor al producto directamente
    if (proveedorSeleccionado) {
        producto.codigo_proveedor = proveedorSeleccionado;
    }
    
    fetch('/api/productos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(producto)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const idProductoGenerado = data.id_producto_generado;
            
            // Si se seleccion√≥ un proveedor, crear la relaci√≥n autom√°ticamente
            if (proveedorSeleccionado) {
                fetch('/api/directorio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_producto: idProductoGenerado,
                        codigo_proveedor: proveedorSeleccionado
                    })
                })
                .then(response => response.json())
                .then(directorioData => {
                    if (directorioData.success) {
                        alert(`‚úÖ Producto y proveedor asignado exitosamente!\n\nüì¶ ${producto.nombre}\nüÜî ID generado: ${idProductoGenerado}\nüìä Stock: ${producto.stock}\nüí∞ Precio: $${producto.valor_unitario}\nüöö Proveedor: Asignado\nüìÖ Vencimiento: ${producto.fecha_venc || 'No especificado'}`);
                    } else {
                        alert(`‚úÖ Producto creado pero fall√≥ la asignaci√≥n del proveedor\n\nüì¶ ${producto.nombre}\nüÜî ID generado: ${idProductoGenerado}\n‚ö†Ô∏è Puede asignar el proveedor manualmente despu√©s`);
                    }
                    completarCreacion();
                })
                .catch(() => {
                    alert(`‚úÖ Producto creado pero fall√≥ la asignaci√≥n del proveedor\n\nüì¶ ${producto.nombre}\nüÜî ID generado: ${idProductoGenerado}\n‚ö†Ô∏è Puede asignar el proveedor manualmente despu√©s`);
                    completarCreacion();
                });
            } else {
                alert(`‚úÖ Producto creado exitosamente!\n\nüì¶ ${producto.nombre}\nüÜî ID generado: ${idProductoGenerado}\nüìä Stock: ${producto.stock}\nüí∞ Precio: $${producto.valor_unitario}\nüìÖ Vencimiento: ${producto.fecha_venc || 'No especificado'}\n\nüí° Recuerde asignar un proveedor despu√©s`);
                completarCreacion();
            }
            
            function completarCreacion() {
            // Cerrar modal y limpiar formulario
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            form.reset();
                cargarProveedores(); // Recargar proveedores en el select
            
            // Recargar p√°gina para mostrar el nuevo producto
            location.reload();
            }
        } else {
            alert('‚ùå Error al crear producto: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        alert('‚ùå Error de conexi√≥n: ' + error.message);
    });
}

// Funci√≥n asignarProveedor ELIMINADA - ahora se hace directamente en crear/editar producto

// Funci√≥n para cargar proveedores en el select del modal de creaci√≥n
function cargarProveedores() {
    fetch('/api/proveedores')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('proveedorSelect');
            select.innerHTML = '<option value="">Sin proveedor (asignar despu√©s)</option>';
            
            if (data.success && data.data.length > 0) {
                data.data.forEach(proveedor => {
                    const option = document.createElement('option');
                    option.value = proveedor.codigo;
                    option.textContent = `${proveedor.nombre} (${proveedor.codigo})`;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">‚ùå No hay proveedores disponibles</option>';
            }
        })
        .catch(() => {
            const select = document.getElementById('proveedorSelect');
            select.innerHTML = '<option value="">‚ùå Error al cargar proveedores</option>';
        });
}

// Funci√≥n para cargar proveedores y seleccionar el actual en edici√≥n
function cargarProveedoresParaEdicion(idProducto) {
    fetch('/api/proveedores')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('edit_proveedorSelect');
            select.innerHTML = '<option value="">Sin proveedor asignado</option>';
            
            if (data.success && data.data.length > 0) {
                data.data.forEach(proveedor => {
                    const option = document.createElement('option');
                    option.value = proveedor.codigo;
                    option.textContent = `${proveedor.nombre} (${proveedor.codigo})`;
                    select.appendChild(option);
                });
                
                // Obtener el proveedor actual del producto
                fetch('/api/directorio')
                    .then(response => response.json())
                    .then(directorioData => {
                        if (directorioData.success) {
                            const relacion = directorioData.data.find(item => item.id_producto === idProducto);
                            if (relacion) {
                                select.value = relacion.codigo_proveedor;
                            }
                        }
                    })
                    .catch(() => {
                        console.log('No se pudo cargar la relaci√≥n actual del producto');
                    });
            }
        })
        .catch(() => {
            const select = document.getElementById('edit_proveedorSelect');
            select.innerHTML = '<option value="">‚ùå Error al cargar proveedores</option>';
        });
}

// Funci√≥n para actualizar producto
function actualizarProducto() {
    const form = document.getElementById('editProductForm');
    const formData = new FormData(form);
    
    const idProducto = parseInt(formData.get('id_producto'));
    const producto = {
        id_marca: 1, // Marca por defecto
        nombre: formData.get('nombre'),
        stock: parseInt(formData.get('stock')),
        valor_unitario: parseFloat(formData.get('valor_unitario')),
        fecha_venc: formData.get('fecha_venc') || null,
        iva: parseInt(formData.get('iva'))
    };
    
    const proveedorSeleccionado = formData.get('codigo_proveedor');
    
    // Validaci√≥n b√°sica
    if (!producto.nombre || producto.stock === null || !producto.valor_unitario) {
        alert('‚ùå Por favor complete todos los campos obligatorios');
        return;
    }
    
    // Agregar proveedor al producto directamente
    if (proveedorSeleccionado) {
        producto.codigo_proveedor = proveedorSeleccionado;
    }
    
    // Actualizar producto
    fetch(`/api/productos/${idProducto}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(producto)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Gestionar el cambio de proveedor
            manejarCambioProveedor(idProducto, proveedorSeleccionado, producto.nombre);
        } else {
            alert('‚ùå Error al actualizar producto: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        alert('‚ùå Error de conexi√≥n: ' + error.message);
    });
}

// Funci√≥n para manejar cambio de proveedor durante edici√≥n
function manejarCambioProveedor(idProducto, nuevoProveedor, nombreProducto) {
    // Primero obtener la relaci√≥n actual
    fetch('/api/directorio')
        .then(response => response.json())
        .then(directorioData => {
            if (directorioData.success) {
                const relacionActual = directorioData.data.find(item => item.id_producto === idProducto);
                
                if (relacionActual && nuevoProveedor && relacionActual.codigo_proveedor !== nuevoProveedor) {
                    // Cambiar proveedor: eliminar relaci√≥n actual y crear nueva
                    fetch(`/api/directorio/${idProducto}/${relacionActual.codigo_proveedor}`, {
                        method: 'DELETE'
                    })
                    .then(() => {
                        return fetch('/api/directorio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id_producto: idProducto,
                                codigo_proveedor: nuevoProveedor
                            })
                        });
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(`‚úÖ Producto y proveedor actualizados exitosamente!\n\nüì¶ ${nombreProducto}\nüöö Proveedor cambiado`);
                        } else {
                            alert(`‚úÖ Producto actualizado pero error al cambiar proveedor\n\nüì¶ ${nombreProducto}\n‚ö†Ô∏è Revise la asignaci√≥n de proveedor`);
                        }
                        completarEdicion();
                    })
                    .catch(() => {
                        alert(`‚úÖ Producto actualizado pero error al cambiar proveedor\n\nüì¶ ${nombreProducto}`);
                        completarEdicion();
                    });
                } else if (!relacionActual && nuevoProveedor) {
                    // Asignar proveedor por primera vez
                    fetch('/api/directorio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id_producto: idProducto,
                            codigo_proveedor: nuevoProveedor
                        })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(`‚úÖ Producto actualizado y proveedor asignado!\n\nüì¶ ${nombreProducto}\nüöö Proveedor asignado`);
                        } else {
                            alert(`‚úÖ Producto actualizado pero error al asignar proveedor\n\nüì¶ ${nombreProducto}`);
                        }
                        completarEdicion();
                    })
                    .catch(() => {
                        alert(`‚úÖ Producto actualizado pero error al asignar proveedor\n\nüì¶ ${nombreProducto}`);
                        completarEdicion();
                    });
                } else if (relacionActual && !nuevoProveedor) {
                    // Remover proveedor
                    fetch(`/api/directorio/${idProducto}/${relacionActual.codigo_proveedor}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(`‚úÖ Producto actualizado y proveedor removido!\n\nüì¶ ${nombreProducto}\nüöö Sin proveedor asignado`);
                        } else {
                            alert(`‚úÖ Producto actualizado pero error al remover proveedor\n\nüì¶ ${nombreProducto}`);
                        }
                        completarEdicion();
                    })
                    .catch(() => {
                        alert(`‚úÖ Producto actualizado pero error al remover proveedor\n\nüì¶ ${nombreProducto}`);
                        completarEdicion();
                    });
                } else {
                    // Sin cambios en proveedor
                    alert(`‚úÖ Producto actualizado exitosamente!\n\nüì¶ ${nombreProducto}`);
                    completarEdicion();
                }
            } else {
                alert(`‚úÖ Producto actualizado exitosamente!\n\nüì¶ ${nombreProducto}`);
                completarEdicion();
            }
        })
        .catch(() => {
            alert(`‚úÖ Producto actualizado exitosamente!\n\nüì¶ ${nombreProducto}`);
            completarEdicion();
        });
    
    function completarEdicion() {
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
        modal.hide();
        
        // Recargar p√°gina para mostrar cambios
        location.reload();
    }
}

// ========================================
// VALIDACIONES PARA PRODUCTOS
// ========================================

function validarNombreProducto(input) {
    const valor = input.value;
    const contador = document.getElementById('contador_nombre_producto');
    const error = document.getElementById('error_nombre_producto');
    
    contador.textContent = `${valor.length}/30`;
    
    if (valor.length === 0) {
        input.classList.remove('is-valid', 'is-invalid');
        error.textContent = '';
    } else if (valor.length > 30) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ùå El nombre no puede exceder 30 caracteres';
    } else if (valor.length < 3) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ö†Ô∏è El nombre debe tener al menos 3 caracteres';
    } else {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
        error.textContent = '';
    }
    
    validarFormularioProducto();
}

// Funciones duplicadas eliminadas - ya est√°n definidas arriba

function validarFormularioProducto() {
    const nombre = document.querySelector('#addProductForm input[name="nombre"]');
    const stock = document.querySelector('#addProductForm input[name="stock"]');
    const precio = document.querySelector('#addProductForm input[name="valor_unitario"]');
    
    const nombreValido = nombre && nombre.classList.contains('is-valid') && nombre.value.length >= 3;
    const stockValido = stock && stock.classList.contains('is-valid') && parseInt(stock.value) >= 0;
    const precioValido = precio && precio.classList.contains('is-valid') && parseFloat(precio.value) > 0;
    
    // Buscar el bot√≥n correcto por onclick
    const btnGuardar = document.querySelector('#addProductModal button[onclick="guardarProducto()"]');
    
    if (btnGuardar) {
        if (nombreValido && stockValido && precioValido) {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save"></i> Guardar Producto';
            btnGuardar.classList.remove('btn-secondary');
            btnGuardar.classList.add('btn-success');
        } else {
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Complete los campos requeridos';
            btnGuardar.classList.remove('btn-success');
            btnGuardar.classList.add('btn-secondary');
        }
    }
}

// Limpiar validaciones al cerrar modal de productos
document.getElementById('addProductModal').addEventListener('hidden.bs.modal', function () {
    const form = document.getElementById('addProductForm');
    form.reset();
    
    // Limpiar validaciones
    document.querySelectorAll('#addProductModal .is-valid, #addProductModal .is-invalid').forEach(el => {
        el.classList.remove('is-valid', 'is-invalid');
    });
    
    // Resetear contador
    const contador = document.getElementById('contador_nombre_producto');
    if (contador) contador.textContent = '0/30';
    
    // Resetear bot√≥n
    const btnGuardar = document.querySelector('#addProductModal button[onclick="guardarProducto()"]');
    if (btnGuardar) {
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Complete los campos requeridos';
        btnGuardar.classList.remove('btn-success');
        btnGuardar.classList.add('btn-secondary');
    }
});

// Cargar proveedores cuando se abre el modal de creaci√≥n
document.getElementById('addProductModal').addEventListener('show.bs.modal', cargarProveedores);

// ========================================
// FUNCIONES DE FILTRADO PARA PRODUCTOS
// ========================================

function aplicarFiltrosProductos() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const stockFilter = document.getElementById('stockFilter').value;
    const estadoFilter = document.getElementById('estadoFilter').value;
    
    const cards = document.querySelectorAll('.producto-card');
    let visibleCount = 0;
    
    cards.forEach(card => {
        const nombre = card.dataset.nombre;
        const stock = parseInt(card.dataset.stock);
        const estado = card.dataset.estado;
        
        let visible = true;
        
        // Filtro de texto
        if (searchText && !nombre.includes(searchText)) {
            visible = false;
        }
        
        // Filtro de stock
        if (stockFilter) {
            if (stockFilter === 'critico' && stock >= 10) visible = false;
            if (stockFilter === 'bajo' && (stock < 10 || stock >= 30)) visible = false;
            if (stockFilter === 'normal' && stock < 30) visible = false;
        }
        
        // Filtro de estado
        if (estadoFilter && estado !== estadoFilter) {
            visible = false;
        }
        
        card.style.display = visible ? 'block' : 'none';
        if (visible) visibleCount++;
    });
    
    // Mostrar mensaje si no hay resultados
    const noResults = document.getElementById('noResultsProductos');
    noResults.style.display = visibleCount === 0 ? 'block' : 'none';
}

function limpiarFiltrosProductos() {
    document.getElementById('searchInput').value = '';
    document.getElementById('stockFilter').value = '';
    document.getElementById('estadoFilter').value = '';
    aplicarFiltrosProductos();
}

// ========================================
// FUNCIONES DE INHABILITACI√ìN/REACTIVACI√ìN DE PRODUCTOS
// ========================================

function habilitarProducto(id, nombre) {
    const mensaje = `‚úÖ CONFIRMAR HABILITACI√ìN\n\nüì¶ Producto: ${nombre} (ID: ${id})\n\n¬øHabilitar este producto?\n\n‚úÖ Volver√° a estar activo\n‚úÖ Disponible para operaciones normales`;

    if (confirm(mensaje)) {
        fetch(`/api/productos/${id}/reactivar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úÖ Producto habilitado exitosamente!\n\nüì¶ "${nombre}" ha sido habilitado.\n\nüí° El producto ya est√° disponible para operaciones normales.`);
                location.reload();
            } else {
                alert('‚ùå Error al habilitar producto: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    }
}

function inhabilitarProducto(id, nombre) {
    const mensaje = `üö´ CONFIRMAR INHABILITACI√ìN\n\nüì¶ Producto: ${nombre} (ID: ${id})\n\n¬øInhabilitar este producto?\n\n‚úÖ El producto ser√° marcado como inactivo\n‚úÖ Los datos se conservan para reactivaci√≥n futura\n‚úÖ No aparecer√° en listados normales`;

    if (confirm(mensaje)) {
        fetch(`/api/productos/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úÖ Producto inhabilitado exitosamente!\n\nüì¶ "${nombre}" ha sido marcado como inactivo.\n\nüí° Se puede reactivar desde el men√∫ de administraci√≥n.`);
                location.reload();
            } else {
                alert('‚ùå Error al inhabilitar producto: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    }
}

// B√∫squeda en tiempo real
document.getElementById('searchInput').addEventListener('input', aplicarFiltrosProductos);
document.getElementById('stockFilter').addEventListener('change', aplicarFiltrosProductos);
document.getElementById('estadoFilter').addEventListener('change', aplicarFiltrosProductos);

// Funciones de prueba eliminadas - Sistema simplificado
</script>
{% endblock %} 