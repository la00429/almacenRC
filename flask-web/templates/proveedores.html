{% extends "base.html" %}

{% block title %}Proveedores - Almac√©nRC{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-truck"></i> Gesti√≥n de Proveedores</h1>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nuevoProveedorModal">
        <i class="fas fa-plus"></i> Nuevo Proveedor
    </button>
</div>

<!-- Alert de restricciones -->
<div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="fas fa-info-circle"></i>
    <strong>Restricciones del sistema:</strong> 
    Nombre m√°ximo 20 caracteres | Tel√©fono m√°ximo 6 d√≠gitos (999,999) | C√≥digo se genera autom√°ticamente
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div class="row">
    {% for proveedor in proveedores %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 {% if proveedor.activo == 'N' %}border-secondary bg-light{% endif %}">
            <div class="card-header {% if proveedor.activo == 'N' %}bg-secondary text-white{% else %}bg-info text-white{% endif %}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                <h5 class="mb-0">{{ proveedor.nombre }}</h5>
                <small>C√≥digo: {{ proveedor.codigo }}</small>
                    </div>
                    {% if proveedor.activo == 'N' %}
                        <span class="badge bg-dark">üö´ INACTIVO</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <p><i class="fas fa-phone"></i> <strong>Tel√©fono:</strong> {{ proveedor.telefono }}</p>
                <p><i class="fas fa-box"></i> <strong>Productos:</strong> {{ proveedor.productos_count }} items</p>
            </div>
            <div class="card-footer">
                {% if proveedor.activo == 'N' %}
                    <!-- Proveedor INACTIVO - Solo habilitar y ver productos -->
                    <div class="btn-group w-100 mb-2">
                        <button class="btn btn-outline-info btn-sm" onclick="verProductosProveedor('{{ proveedor.codigo }}', '{{ proveedor.nombre }}')">
                            <i class="fas fa-boxes"></i> Ver Productos
                        </button>
                    </div>
                    <button class="btn btn-success btn-sm w-100" onclick="habilitarProveedor('{{ proveedor.codigo }}', '{{ proveedor.nombre }}')">
                        <i class="fas fa-check-circle"></i> Habilitar Proveedor
                    </button>
                {% else %}
                    <!-- Proveedor ACTIVO - Funciones normales -->
                    <div class="btn-group w-100 mb-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="editarProveedor('{{ proveedor.codigo }}', '{{ proveedor.nombre }}', '{{ proveedor.telefono }}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="verProductosProveedor('{{ proveedor.codigo }}', '{{ proveedor.nombre }}')">
                        <i class="fas fa-boxes"></i> Productos
                    </button>
                </div>
                    <button class="btn btn-outline-warning btn-sm w-100" onclick="inhabilitarProveedor('{{ proveedor.codigo }}', '{{ proveedor.nombre }}', {{ proveedor.productos_count }})">
                        <i class="fas fa-ban"></i> Inhabilitar Proveedor
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal para nuevo proveedor -->
<div class="modal fade" id="nuevoProveedorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üÜï Nuevo Proveedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="nuevoProveedorForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üè¢ Nombre del Proveedor</label>
                                <input type="text" class="form-control" name="nombre" id="nuevo_nombre" required maxlength="20" 
                                       placeholder="Ej: AutoParts S.A." oninput="validarNombre(this)">
                                <div class="form-text">
                                    <span id="contador_nombre">0/20</span> caracteres
                                    <i class="fas fa-exclamation-triangle text-warning ms-2"></i>
                                    <small>M√°ximo 20 caracteres</small>
                                </div>
                                <div class="invalid-feedback" id="error_nombre"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üìû Tel√©fono</label>
                                <input type="number" class="form-control" name="telefono" id="nuevo_telefono" required 
                                       min="1" max="999999" placeholder="123456" oninput="validarTelefono(this)">
                                <div class="form-text">
                                    <span id="contador_telefono">0/6</span> d√≠gitos
                                    <i class="fas fa-exclamation-triangle text-warning ms-2"></i>
                                    <small>M√°ximo 6 d√≠gitos (1-999,999)</small>
                                </div>
                                <div class="invalid-feedback" id="error_telefono"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-primary">
                                <i class="fas fa-info-circle"></i>
                                <strong>Informaci√≥n:</strong> El c√≥digo del proveedor se generar√° autom√°ticamente usando la secuencia SEQ_PROVEEDORES.
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="guardarProveedor()" id="btn_guardar_proveedor" disabled>
                    <i class="fas fa-save"></i> Guardar Proveedor
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar proveedor -->
<div class="modal fade" id="editarProveedorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Editar Proveedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editarProveedorForm">
                    <input type="hidden" name="codigo" id="edit_codigo">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üÜî C√≥digo</label>
                                <input type="text" class="form-control" id="edit_codigo_display" readonly>
                                <div class="form-text">
                                    <i class="fas fa-lock text-muted"></i>
                                    <small>El c√≥digo no se puede modificar</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">üè¢ Nombre del Proveedor</label>
                                <input type="text" class="form-control" name="nombre" id="edit_nombre" required maxlength="20" 
                                       oninput="validarNombreEdit(this)">
                                <div class="form-text">
                                    <span id="contador_nombre_edit">0/20</span> caracteres
                                </div>
                                <div class="invalid-feedback" id="error_nombre_edit"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üìû Tel√©fono</label>
                                <input type="number" class="form-control" name="telefono" id="edit_telefono" required 
                                       min="1" max="999999" oninput="validarTelefonoEdit(this)">
                                <div class="form-text">
                                    <span id="contador_telefono_edit">0/6</span> d√≠gitos
                                </div>
                                <div class="invalid-feedback" id="error_telefono_edit"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="actualizarProveedor()" id="btn_actualizar_proveedor" disabled>
                    <i class="fas fa-save"></i> Actualizar Proveedor
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ========================================
// VALIDACIONES EN TIEMPO REAL 
// ========================================

function validarNombre(input) {
    const valor = input.value;
    const contador = document.getElementById('contador_nombre');
    const error = document.getElementById('error_nombre');
    const btnGuardar = document.getElementById('btn_guardar_proveedor');
    
    contador.textContent = `${valor.length}/20`;
    
    if (valor.length === 0) {
        input.classList.remove('is-valid', 'is-invalid');
        error.textContent = '';
    } else if (valor.length > 20) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ùå El nombre no puede exceder 20 caracteres';
    } else if (valor.length < 3) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ö†Ô∏è El nombre debe tener al menos 3 caracteres';
    } else {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
        error.textContent = '';
    }
    
    validarFormularioCompleto();
}

function validarTelefono(input) {
    const valor = parseInt(input.value) || 0;
    const contador = document.getElementById('contador_telefono');
    const error = document.getElementById('error_telefono');
    
    contador.textContent = `${input.value.length}/6`;
    
    if (input.value === '') {
        input.classList.remove('is-valid', 'is-invalid');
        error.textContent = '';
    } else if (valor < 1) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ùå El tel√©fono debe ser mayor a 0';
    } else if (valor > 999999) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ùå El tel√©fono no puede exceder 999,999';
    } else if (input.value.length < 4) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ö†Ô∏è El tel√©fono debe tener al menos 4 d√≠gitos';
    } else {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
        error.textContent = '';
    }
    
    validarFormularioCompleto();
}

function validarFormularioCompleto() {
    const nombre = document.getElementById('nuevo_nombre');
    const telefono = document.getElementById('nuevo_telefono');
    const btnGuardar = document.getElementById('btn_guardar_proveedor');
    
    const nombreValido = nombre.classList.contains('is-valid');
    const telefonoValido = telefono.classList.contains('is-valid');
    
    if (nombreValido && telefonoValido) {
        btnGuardar.disabled = false;
        btnGuardar.classList.remove('btn-secondary');
        btnGuardar.classList.add('btn-success');
    } else {
        btnGuardar.disabled = true;
        btnGuardar.classList.remove('btn-success');
        btnGuardar.classList.add('btn-secondary');
    }
}

// Validaciones para modal de edici√≥n
function validarNombreEdit(input) {
    const valor = input.value;
    const contador = document.getElementById('contador_nombre_edit');
    const error = document.getElementById('error_nombre_edit');
    
    contador.textContent = `${valor.length}/20`;
    
    if (valor.length === 0) {
        input.classList.remove('is-valid', 'is-invalid');
        error.textContent = '';
    } else if (valor.length > 20) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ùå El nombre no puede exceder 20 caracteres';
    } else if (valor.length < 3) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ö†Ô∏è El nombre debe tener al menos 3 caracteres';
    } else {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
        error.textContent = '';
    }
    
    validarFormularioEdicion();
}

function validarTelefonoEdit(input) {
    const valor = parseInt(input.value) || 0;
    const contador = document.getElementById('contador_telefono_edit');
    const error = document.getElementById('error_telefono_edit');
    
    contador.textContent = `${input.value.length}/6`;
    
    if (input.value === '') {
        input.classList.remove('is-valid', 'is-invalid');
        error.textContent = '';
    } else if (valor < 1) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ùå El tel√©fono debe ser mayor a 0';
    } else if (valor > 999999) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ùå El tel√©fono no puede exceder 999,999';
    } else if (input.value.length < 4) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        error.textContent = '‚ö†Ô∏è El tel√©fono debe tener al menos 4 d√≠gitos';
    } else {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
        error.textContent = '';
    }
    
    validarFormularioEdicion();
}

function validarFormularioEdicion() {
    const nombre = document.getElementById('edit_nombre');
    const telefono = document.getElementById('edit_telefono');
    const btnActualizar = document.getElementById('btn_actualizar_proveedor');
    
    const nombreValido = nombre.classList.contains('is-valid');
    const telefonoValido = telefono.classList.contains('is-valid');
    
    if (nombreValido && telefonoValido) {
        btnActualizar.disabled = false;
        btnActualizar.classList.remove('btn-secondary');
        btnActualizar.classList.add('btn-primary');
    } else {
        btnActualizar.disabled = true;
        btnActualizar.classList.remove('btn-primary');
        btnActualizar.classList.add('btn-secondary');
    }
}

// ========================================
// FUNCIONES PRINCIPALES 
// ========================================

function guardarProveedor() {
    const form = document.getElementById('nuevoProveedorForm');
    const formData = new FormData(form);
    
    const proveedor = {
        nombre: formData.get('nombre'),
        telefono: parseInt(formData.get('telefono'))
    };
    
    // Mostrar loading
    const btnGuardar = document.getElementById('btn_guardar_proveedor');
    const textoOriginal = btnGuardar.innerHTML;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    btnGuardar.disabled = true;
    
    fetch('/api/proveedores', {
        method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(proveedor)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
            // Mostrar modal de √©xito
            const modalExito = `
                <div class="modal fade" id="exitoModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">‚úÖ ¬°Proveedor Creado!</h5>
                            </div>
                            <div class="modal-body">
                                <div class="text-center">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <h4>üè¢ ${proveedor.nombre}</h4>
                                    <p><strong>üÜî C√≥digo generado:</strong> ${data.codigo_generado}</p>
                                    <p><strong>üìû Tel√©fono:</strong> ${proveedor.telefono}</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" onclick="location.reload()">
                                    <i class="fas fa-check"></i> ¬°Perfecto!
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalExito);
            const exitoModalElement = new bootstrap.Modal(document.getElementById('exitoModal'));
            
            // Cerrar modal de creaci√≥n
            const modal = bootstrap.Modal.getInstance(document.getElementById('nuevoProveedorModal'));
            modal.hide();
            
            // Mostrar modal de √©xito
            exitoModalElement.show();
            
            } else {
            // Mostrar error espec√≠fico
            let mensajeError = '‚ùå Error al crear proveedor: ' + data.error;
            if (data.error.includes('ORA-20012')) {
                mensajeError = '‚ùå Error en la base de datos. Verifique que los datos cumplan las restricciones.';
            }
            
            alert(mensajeError);
            btnGuardar.innerHTML = textoOriginal;
            btnGuardar.disabled = false;
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        btnGuardar.innerHTML = textoOriginal;
        btnGuardar.disabled = false;
        });
}

function editarProveedor(codigo, nombre, telefono) {
    // Llenar el modal de edici√≥n
    document.getElementById('edit_codigo').value = codigo;
    document.getElementById('edit_codigo_display').value = codigo;
    document.getElementById('edit_nombre').value = nombre;
    document.getElementById('edit_telefono').value = telefono;
    
    // Actualizar contadores
    document.getElementById('contador_nombre_edit').textContent = `${nombre.length}/20`;
    document.getElementById('contador_telefono_edit').textContent = `${telefono.toString().length}/6`;
    
    // Validar campos iniciales
    validarNombreEdit(document.getElementById('edit_nombre'));
    validarTelefonoEdit(document.getElementById('edit_telefono'));
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('editarProveedorModal'));
    modal.show();
}

function actualizarProveedor() {
    const form = document.getElementById('editarProveedorForm');
    const formData = new FormData(form);
    
    const codigo = formData.get('codigo');
    const proveedor = {
        nombre: formData.get('nombre'),
        telefono: parseInt(formData.get('telefono'))
    };
    
    // Mostrar loading
    const btnActualizar = document.getElementById('btn_actualizar_proveedor');
    const textoOriginal = btnActualizar.innerHTML;
    btnActualizar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
    btnActualizar.disabled = true;
    
    fetch(`/api/proveedores/${codigo}`, {
        method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(proveedor)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
            alert(`‚úÖ Proveedor actualizado exitosamente!\n\nüÜî C√≥digo: ${codigo}\nüè¢ Nombre: ${proveedor.nombre}\nüìû Tel√©fono: ${proveedor.telefono}`);
                location.reload();
            } else {
            alert('‚ùå Error al actualizar proveedor: ' + data.error);
            btnActualizar.innerHTML = textoOriginal;
            btnActualizar.disabled = false;
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        btnActualizar.innerHTML = textoOriginal;
        btnActualizar.disabled = false;
        });
}

function verProductosProveedor(codigo, nombre) {
    fetch(`/api/proveedores/${codigo}/productos`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.data.length === 0) {
                    alert(`üì¶ PRODUCTOS DEL PROVEEDOR\n\nüè¢ ${nombre} (C√≥digo: ${codigo})\n\n‚ùå No tiene productos asignados`);
                } else {
                    let productosTexto = `üì¶ PRODUCTOS DEL PROVEEDOR\n\nüè¢ ${nombre} (C√≥digo: ${codigo})\nüìä Total: ${data.total} productos\n\n`;
                    
                    data.data.forEach(p => {
                        const estado = p.estado_stock === 'CRITICO' ? 'üö®' : p.estado_stock === 'BAJO' ? '‚ö†Ô∏è' : '‚úÖ';
                        productosTexto += `${estado} ${p.nombre} (ID: ${p.id_producto})\n   üìä Stock: ${p.stock} | üí∞ $${p.valor_unitario.toLocaleString()}\n\n`;
                    });
                    
                    productosTexto += `\nüö® = Cr√≠tico | ‚ö†Ô∏è = Bajo | ‚úÖ = Normal`;
                    alert(productosTexto);
                }
            } else {
                alert('‚ùå Error al obtener productos: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
}

// ========================================
// FUNCIONES DE INHABILITACI√ìN/REACTIVACI√ìN DE PROVEEDORES
// ========================================

function habilitarProveedor(codigo, nombre) {
    const mensaje = `‚úÖ CONFIRMAR HABILITACI√ìN\n\nüè¢ Proveedor: ${nombre} (C√≥digo: ${codigo})\n\n¬øHabilitar este proveedor?\n\n‚úÖ Volver√° a estar activo\n‚úÖ Disponible para asignaciones normales`;

    if (confirm(mensaje)) {
        // Realizar habilitaci√≥n
        console.log('Habilitando proveedor:', codigo, nombre);
        
        fetch(`/api/proveedores/${codigo}/reactivar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            console.log('Respuesta recibida:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Datos:', data);
            if (data.success) {
                alert(`‚úÖ Proveedor habilitado exitosamente!\n\nüè¢ "${nombre}" ha sido habilitado.\n\nüí° El proveedor ya est√° disponible para asignaciones normales.`);
                location.reload();
            } else {
                alert('‚ùå Error al habilitar proveedor: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    }
}

function inhabilitarProveedor(codigo, nombre, productosCount) {
    const mensaje = `‚ö†Ô∏è CONFIRMAR INHABILITACI√ìN\n\nüè¢ Proveedor: ${nombre} (C√≥digo: ${codigo})\nüì¶ Productos asignados: ${productosCount}\n\n¬øInhabilitar este proveedor?\n\n‚úÖ Esta acci√≥n es REVERSIBLE\n‚úÖ Se mantiene toda la informaci√≥n\n‚úÖ Se puede reactivar despu√©s`;

    if (confirm(mensaje)) {
        // Realizar inhabilitaci√≥n
        console.log('Inhabilitando proveedor:', codigo, nombre);
        
        fetch(`/api/proveedores/${codigo}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            console.log('Respuesta recibida:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Datos:', data);
            if (data.success) {
                alert(`‚úÖ Proveedor inhabilitado exitosamente!\n\nüè¢ "${nombre}" ha sido inhabilitado.\n\nüí° Para reactivar use el bot√≥n "Habilitar".`);
                location.reload();
            } else {
                alert('‚ùå Error al inhabilitar proveedor: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    }
}

// Limpiar formulario al cerrar modal
document.getElementById('nuevoProveedorModal').addEventListener('hidden.bs.modal', function () {
    const form = document.getElementById('nuevoProveedorForm');
    form.reset();
    
    // Limpiar validaciones
    document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
        el.classList.remove('is-valid', 'is-invalid');
    });
    
    // Resetear contadores
    document.getElementById('contador_nombre').textContent = '0/20';
    document.getElementById('contador_telefono').textContent = '0/6';
    
    // Resetear bot√≥n
    const btnGuardar = document.getElementById('btn_guardar_proveedor');
    btnGuardar.disabled = true;
    btnGuardar.classList.remove('btn-success');
    btnGuardar.classList.add('btn-secondary');
});
</script>
{% endblock %} 