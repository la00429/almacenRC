{% extends "base.html" %}

{% block title %}Proveedores - Almac√©nRC{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-truck"></i> Gesti√≥n de Proveedores</h1>
    <button class="btn btn-success" onclick="nuevoProveedor()">
        <i class="fas fa-plus"></i> Nuevo Proveedor
    </button>
</div>

<div class="row">
    {% for proveedor in proveedores %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">{{ proveedor.nombre }}</h5>
                <small>C√≥digo: {{ proveedor.codigo }}</small>
            </div>
            <div class="card-body">
                <p><i class="fas fa-phone"></i> <strong>Tel√©fono:</strong> {{ proveedor.telefono }}</p>
                <p><i class="fas fa-box"></i> <strong>Productos:</strong> {{ proveedor.productos_count }} items</p>
            </div>
            <div class="card-footer">
                <div class="btn-group w-100">
                    <button class="btn btn-outline-primary btn-sm" onclick="editarProveedor('{{ proveedor.codigo }}', '{{ proveedor.nombre }}', '{{ proveedor.telefono }}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="verProductosProveedor('{{ proveedor.codigo }}', '{{ proveedor.nombre }}')">
                        <i class="fas fa-boxes"></i> Productos
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
function editarProveedor(codigo, nombre, telefono) {
    const nuevoNombre = prompt(`‚úèÔ∏è EDITAR PROVEEDOR\n\nC√≥digo: ${codigo}\nNombre actual: ${nombre}\n\nIngrese el nuevo nombre:`, nombre);
    const nuevoTelefono = prompt(`üìû Ingrese el nuevo tel√©fono:`, telefono);
    
    if (nuevoNombre && nuevoTelefono && (nuevoNombre !== nombre || nuevoTelefono !== telefono)) {
        // Llamar a la API PUT para actualizar el proveedor usando PKG_PROVEEDORES.PR_ACTUALIZAR_PROVEEDOR
        fetch(`/api/proveedores/${codigo}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                nombre: nuevoNombre,
                telefono: nuevoTelefono
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úÖ Proveedor actualizado exitosamente!\n\nüÜî C√≥digo: ${codigo}\nüè¢ Nombre: ${nuevoNombre}\nüìû Tel√©fono: ${nuevoTelefono}`);
                // Recargar la p√°gina para mostrar los cambios
                location.reload();
            } else {
                alert('‚ùå Error al actualizar proveedor: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    }
}

function nuevoProveedor() {
    const codigo = prompt('üÜî Ingrese el c√≥digo del proveedor:');
    const nombre = prompt('üè¢ Ingrese el nombre del proveedor:');
    const telefono = prompt('üìû Ingrese el tel√©fono:');
    
    if (codigo && nombre && telefono && !isNaN(codigo)) {
        fetch('/api/proveedores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                codigo: parseInt(codigo),
                nombre: nombre,
                telefono: parseInt(telefono)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`‚úÖ Proveedor creado exitosamente!\n\nüè¢ ${nombre}\nüÜî C√≥digo: ${codigo}\nüìû Tel√©fono: ${telefono}`);
                location.reload();
            } else {
                alert('‚ùå Error al crear proveedor: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
    } else if (codigo !== null) {
        alert('‚ùå Por favor complete todos los campos correctamente');
    }
}

function verProductosProveedor(codigo, nombre) {
    fetch(`/api/proveedores/${codigo}/productos`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.data.length === 0) {
                    alert(`üì¶ PRODUCTOS DEL PROVEEDOR\n\nüè¢ ${nombre} (C√≥digo: ${codigo})\n\n‚ùå No tiene productos asignados`);
                } else {
                    let productosTexto = `üì¶ PRODUCTOS DEL PROVEEDOR\n\nüè¢ ${nombre} (C√≥digo: ${codigo})\nüìä Total: ${data.total} productos\n\n`;
                    
                    data.data.forEach(p => {
                        const estado = p.estado_stock === 'CRITICO' ? 'üö®' : p.estado_stock === 'BAJO' ? '‚ö†Ô∏è' : '‚úÖ';
                        productosTexto += `${estado} ${p.nombre} (ID: ${p.id_producto})\n   üìä Stock: ${p.stock} | üí∞ $${p.valor_unitario.toLocaleString()}\n\n`;
                    });
                    
                    productosTexto += `\nüö® = Cr√≠tico | ‚ö†Ô∏è = Bajo | ‚úÖ = Normal`;
                    alert(productosTexto);
                }
            } else {
                alert('‚ùå Error al obtener productos: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
        });
}
</script>
{% endblock %} 